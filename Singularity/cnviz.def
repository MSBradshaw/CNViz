Bootstrap: docker
From: debian

%files
    environment.yml /opt/environment.yml


%environment
    PATH=/opt/miniconda/envs/$(head -1 /opt/environment.yml | cut -d' ' -f2)/bin:$PATH

%post


    apt-get update 
    apt-get -y install build-essential

    conda_base_dir=/opt/miniconda
    conda_bin_dir="${conda_base_dir}/bin"
    conda="${conda_bin_dir}/conda"
    
    apt-get -y install wget bzip2 procps git binutils bc

    # Get and Install the minconda
    #wget -c https://repo.continuum.io/miniconda/Miniconda2-latest-Linux-x86_64.sh -O miniconda.sh
    wget -c https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh
    /bin/bash miniconda.sh -b -p ${conda_base_dir} && rm -f miniconda.sh

    # create a conda environment for this pipeline:
    ${conda} env create  -f /opt/environment.yml

    apt-get install -y --no-install-recommends python3 python3-pip python3-wheel python3-setuptools gcc libpq-dev python3-dev
    ln -s /usr/bin/python3 /usr/bin/python
    ${conda} install numpy scipy pandas openpyxl xlsxwriter
    apt-get -y clean
    rm -rf rm -rf /var/lib/apt/lists/*

    wget https://github.com/arq5x/bedtools2/releases/download/v2.30.0/bedtools.static.binary
    mv bedtools.static.binary /bin/bedtools
    chmod a+x /bin/bedtools 

    ${conda} install -c bioconda htslib

    # ${conda} install -c bioconda samtools bcftools

    apt-get update
    apt-get -y install locales apt-utils
    apt-get -y install wget bzip2 procps git binutils bc
    apt-get -y install gnuplot-qt gnuplot 
    apt-get install -y libgl1
    apt-get -y install flex unzip libbz2-dev liblzma-dev  autoconf make gcc libz-dev libssl-dev libcurl4-openssl-dev
    apt-get -y install cut head bgzip
    cd /opt

    # install htslib
    git clone https://github.com/samtools/htslib.git
    cd htslib
    git submodule update --init --recursive
    autoheader
    autoconf
    ./configure --disable-bz2 --disable-lzma --enable-libcurl
    make -j8 && echo "Done"
    cd ..    

    apt-get install libncurses-dev

    wget https://github.com/samtools/samtools/releases/download/1.13/samtools-1.13.tar.bz2
    tar -xf samtools-1.13.tar.bz2
    cd samtools-1.13
    ./configure --prefix=/opt/bin
    make
    make install
    mv /opt/samtools-1.13/samtools /usr/bin/
